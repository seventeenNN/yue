# 时钟

### 时钟是什么

“时钟”（Clock）是一个非常重要的概念，它指的是一个周期性信号，用于同步系统中各个组件的操作。时钟信号通常是一个固定频率的方波，它决定了系统中各个操作的节奏和时间顺序。

时钟的基本特性
频率：时钟信号的频率是指每秒钟发生的周期数，单位是赫兹（Hz）。例如，1 GHz的时钟频率意味着每秒钟有10亿个周期。

周期：时钟信号的周期是指一个完整周期的时间长度，它是频率的倒数。例如，1 GHz的时钟频率对应的周期是1纳秒（ns）。

占空比：时钟信号的占空比是指高电平时间与整个周期时间的比值。通常，时钟信号的占空比是50%，即高电平时间和低电平时间各占一半。

### 为什么要有时钟

时钟（Clock）是一个至关重要的组件，它提供了一个基准时间信号，用于同步系统中各个组件的操作。以下是为什么需要有时钟的几个主要原因：

同步操作：时钟信号确保系统中的各个组件（如CPU、内存、外设等）在正确的时间点执行操作。没有时钟信号，这些组件可能无法同步工作，导致数据冲突和操作错误。

控制数据流：在数字电路中，时钟信号控制数据的传输和处理。例如，CPU在每个时钟周期内执行一条指令，内存则在时钟信号的控制下读取或写入数据。

性能优化：时钟频率决定了系统的操作速度。通过设置合适的时钟频率，可以优化系统的性能，使其在处理任务时更加高效。

节能管理：虽然时钟信号的持续运行会消耗电力，但在需要执行操作时开启时钟是必要的。现代系统通常采用动态频率调整（Dynamic Frequency Scaling, DFS）和时钟门控（Clock Gating）等技术，以在不需要时关闭或降低时钟频率，从而节省电力。

稳定性保障：正确的时钟配置有助于确保系统的稳定性。不正确的时钟设置可能导致系统运行不稳定或无法正常工作。

硬件保护：持续的高频操作可能导致硬件过热或损坏。通过在不需要时关闭时钟，可以保护硬件免受长时间高频操作的影响。

时间基准：在某些应用中，时钟信号还用于提供时间基准，例如在通信系统中用于同步数据传输，或在实时操作系统中用于任务调度。

它确保了系统中各个组件能够正确、高效且稳定地运行。时钟信号是同步各个组件操作的关键，对于系统的性能、稳定性和功耗管理至关重要。

### 为什么要配置不同的时钟

配置不同的时钟是为了满足多种需求和优化系统性能。以下是为什么要配置不同时钟的几个主要原因：

性能优化：不同的应用和任务可能需要不同的处理速度。通过配置不同的时钟频率，可以根据需求调整系统的性能，例如在进行高强度计算时提高时钟频率，而在待机或低负载时降低时钟频率。

节能管理：持续的高频操作会消耗大量电力。通过配置不同的时钟频率，可以在不需要高性能时降低时钟频率，从而节省电力，延长电池寿命，特别是在移动设备和嵌入式系统中尤为重要。

稳定性保障：某些硬件组件可能对时钟频率有特定的要求，过高或过低的时钟频率可能导致系统不稳定或无法正常工作。通过配置合适的时钟频率，可以确保系统的稳定性。

兼容性考虑：不同的硬件组件（如CPU、内存、外设等）可能支持不同的时钟频率。配置不同的时钟频率可以确保这些组件能够正确协同工作，避免兼容性问题。

多任务处理：在多任务操作系统中，不同的任务可能需要不同的时钟频率。通过配置不同的时钟，可以为不同的任务提供合适的时间基准，确保任务能够高效且有序地执行。

硬件保护：持续的高频操作可能导致硬件过热或损坏。通过配置不同的时钟频率，可以在不需要时降低时钟频率，减少硬件的负担，保护硬件免受损坏。

动态频率调整（DFS）：现代系统通常支持动态频率调整，即根据系统负载实时调整时钟频率。这种技术可以在保证性能的同时，最大限度地节省电力。

配置不同的时钟是为了根据不同的应用需求和系统状态，优化性能、节省电力、确保稳定性、提高兼容性、支持多任务处理以及保护硬件。通过灵活配置时钟，可以使系统更加高效、稳定和可靠。

### 为什么程序启动前要先开时钟

同步操作：时钟信号确保系统中的各个组件（如CPU、内存、外设等）在正确的时间点执行操作。没有时钟信号，这些组件可能无法同步工作，导致数据冲突和操作错误。

初始化顺序：在系统启动或复位时，需要按照特定的顺序初始化各个组件。开启时钟是这个初始化过程的一部分，确保所有组件在正确的时机开始工作。

性能优化：时钟频率决定了系统的操作速度。通过开启时钟并设置合适的频率，可以优化系统的性能，使其在处理任务时更加高效。

节能管理：虽然时钟信号的持续运行会消耗电力，但在需要执行操作时开启时钟是必要的。现代系统通常采用动态频率调整（Dynamic Frequency Scaling, DFS）和时钟门控（Clock Gating）等技术，以在不需要时关闭或降低时钟频率，从而节省电力。

稳定性保障：正确的时钟配置有助于确保系统的稳定性。不正确的时钟设置可能导致系统运行不稳定或无法正常工作。

硬件保护：持续的高频操作可能导致硬件过热或损坏。通过在不需要时关闭时钟，可以保护硬件免受长时间高频操作的影响。

开启时钟是为了确保电子设备和计算机系统能够正确、高效且稳定地运行。时钟信号是同步各个组件操作的关键，对于系统的性能、稳定性和功耗管理至关重要。在运行程序之前开启时钟，可以确保系统准备好执行指令，避免因时钟信号缺失而导致的问题。

### 为什么不一直开着时钟

不一直开着时钟（Clock）有以下几个主要原因：

节能：一直开启时钟会持续消耗电力，尤其是在移动设备和嵌入式系统中，节能是一个重要的考虑因素。在不执行操作时关闭或降低时钟频率可以显著减少功耗，延长电池寿命。

避免干扰：在某些情况下，如系统休眠或待机状态，不需要时钟信号一直运行。关闭时钟可以避免不必要的干扰，确保系统在需要时能够快速响应。

硬件保护：持续的高频操作可能导致硬件过热或损坏。通过在不需要时关闭时钟，可以保护硬件免受长时间高频操作的影响。

灵活性：根据不同的应用场景和需求，系统可能需要动态调整时钟频率。例如，在进行高强度计算时提高时钟频率，而在待机或低负载时降低时钟频率。

时钟门控（Clock Gating）：这是一种技术，通过在不需要时关闭某些组件的时钟信号，来减少功耗。这可以应用于特定的硬件模块或外设，当它们不活跃时，可以关闭它们的时钟以节省电力。

动态频率调整（Dynamic Frequency Scaling, DFS）：这是一种根据系统负载动态调整时钟频率的技术，以平衡性能和功耗。在低负载时降低时钟频率，可以显著减少功耗。

初始化顺序：在系统启动时，可能需要按照特定顺序开启时钟，确保各个组件正确初始化并同步工作。在启动完成后，可以根据需要调整时钟频率。

不一直开着时钟可以带来节能、保护硬件、提高系统灵活性和响应速度等好处。通过智能管理时钟信号，可以在确保系统性能的同时，最大限度地减少功耗和硬件负担。






## 时钟和晶振

晶振（Crystal Oscillator）：

晶振是一种电子元件，它利用晶体的压电效应来产生稳定的频率信号。晶体（通常是石英晶体）在受到电压作用时会产生机械振动，这种振动在特定频率下非常稳定，因此晶振可以提供精确的时钟信号。

晶振可以是外部的，也可以是内部的（集成在微控制器或芯片内部）。外部晶振通常需要配合外部电容来构成一个完整的振荡电路。

时钟（Clock）：

时钟是指在电子设备中用于同步各个部件操作的周期性信号。在数字电路中，时钟信号决定了数据处理的速度和时序。

时钟信号通常由晶振产生，晶振提供的稳定频率信号经过分频或倍频处理后，形成适合设备运行的时钟信号。

关系总结：

晶振是产生时钟信号的源头，它提供了基础的频率信号。

时钟信号是晶振产生的频率信号经过处理后的结果，用于同步和控制电子设备中的各个部件。

### 晶振和振荡器

晶振（Crystal Oscillator）：

晶振是一种利用晶体的压电效应来产生稳定频率信号的元件。晶体通常是石英晶体，它在受到电压作用时会产生机械振动，这种振动在特定频率下非常稳定。

晶振可以是单个晶体（无源晶振），也可以是包含晶体和有源电路的模块（有源晶振）。无源晶振需要外部电路（如放大器）来驱动，而有源晶振内部集成了驱动电路，可以直接输出稳定的频率信号。

振荡器（Oscillator）：

振荡器是一个更广泛的概念，它指的是任何能够产生周期性信号的电路或设备。振荡器可以是基于晶体的（如晶振），也可以是基于其他原理的，例如RC振荡器、LC振荡器等。

振荡器可以是简单的电路，也可以是复杂的模块。它们的主要功能是产生稳定的频率信号，用于同步和控制电子设备中的各个部件。

关系和区别：

晶振是振荡器的一种，它特指利用晶体来产生稳定频率信号的振荡器。

振荡器是一个更广泛的概念，包括所有能够产生周期性信号的电路或设备，而晶振是其中一种特定类型的振荡器。

### 有源晶振，无源晶振

1. 有源晶振（Active Crystal Oscillator）：
有源晶振通常指的是一个完整的振荡器模块，它内部集成了晶体谐振器、振荡电路和必要的放大器。有源晶振可以直接输出一个稳定的频率信号，不需要外部电路来启动或维持振荡。有源晶振的输出通常是方波信号，频率范围可以从几十kHz到几GHz。由于其内部集成了放大器，有源晶振的输出信号幅度通常比无源晶振更大，且稳定性更高。有源晶振的常见类型包括石英晶体振荡器（XO）、温度补偿晶体振荡器（TCXO）、电压控制晶体振荡器（VCXO）和恒温控制晶体振荡器（OCXO）。

2. 无源晶振（Passive Crystal Oscillator）：
无源晶振通常指的是晶体谐振器本身，它需要外部电路（如放大器、反馈电阻等）来启动和维持振荡。无源晶振本身不包含振荡电路，因此不能直接输出振荡信号。无源晶振通常与一个或多个外部元件（如电容、电阻）一起使用，构成一个完整的振荡电路。无源晶振的频率通常由晶体的物理尺寸和切割方式决定，常见的无源晶振频率范围从几kHz到几百MHz。无源晶振的优点是成本较低，但由于需要外部电路，设计和调试相对复杂。

总结来说，有源晶振是一个完整的振荡器模块，可以直接输出稳定的频率信号，而无源晶振是一个晶体谐振器，需要外部电路来产生振荡信号。选择有源晶振还是无源晶振取决于具体的应用需求、成本预算和设计复杂度。

### 内部晶振和外部晶振

内部晶振（Internal Crystal Oscillator）和外部晶振（External Crystal Oscillator）是电子设备中用于产生时钟信号的两种不同配置方式。它们的主要区别在于晶振的位置和集成方式。

**内部晶振（Internal Crystal Oscillator）：**

内部晶振是指晶振电路集成在芯片或微控制器内部的配置。这种晶振通常是一个RC振荡器（Resistor-Capacitor Oscillator）或一个集成的晶体振荡器。

内部晶振的优点是简化了外部电路设计，不需要外部晶体和电容，从而减少了电路板的复杂性和成本。

内部晶振的缺点是通常精度不如外部晶振高，且频率稳定性可能较差。因此，内部晶振通常用于对时钟精度要求不高的应用。

**外部晶振（External Crystal Oscillator）：**

外部晶振是指晶振电路位于芯片或微控制器外部，通常是一个外部晶体或陶瓷谐振器，配合两个外部电容构成一个完整的振荡电路。

外部晶振的优点是能够提供更高的频率精度和稳定性，因为外部晶体通常比内部晶振更精确。

外部晶振的缺点是需要外部元件，增加了电路板的复杂性和成本。

总结来说，内部晶振和外部晶振的选择取决于应用的具体需求。如果对时钟信号的精度和稳定性要求较高，通常会选择外部晶振；如果对成本和电路简化要求较高，且对时钟精度要求不高，则可以选择内部晶振。在微控制器（如STM32）中，通常既支持内部晶振（如HSI，High-Speed Internal），也支持外部晶振（如HSE，High-Speed External），用户可以根据实际应用需求进行选择。





## 介绍stm32时钟部分：

在STM32微控制器中，时钟系统是一个非常关键的部分，它负责为微控制器的各个模块提供同步信号。STM32的时钟系统通常包括以下几种时钟源：

1. **高速外部时钟（HSE，High-Speed External）**：
   - HSE通常是一个外部晶体振荡器或陶瓷谐振器，配合两个外部电容构成一个振荡电路。HSE可以提供较高的频率，通常为4-26 MHz，具体取决于所使用的晶体或谐振器。
   - HSE的优点是频率精度高，稳定性好，适用于对时钟精度要求较高的应用。

2. **高速内部时钟（HSI，High-Speed Internal）**：
   - HSI是STM32内部集成的RC振荡器，可以直接提供时钟信号，不需要外部晶体或谐振器。HSI的典型频率为16 MHz。
   - HSI的优点是成本低，电路设计简单，但频率精度和稳定性通常不如HSE。

3. **低速外部时钟（LSE，Low-Speed External）**：
   - LSE通常是一个32.768 kHz的外部晶体振荡器，用于提供低速、高精度的时钟信号，常用于实时时钟（RTC）和日历功能。
   - LSE的优点是频率稳定，适用于需要长时间计时和低功耗的应用。

4. **低速内部时钟（LSI，Low-Speed Internal）**：
   - LSI是STM32内部集成的RC振荡器，频率通常为32-40 kHz，用于提供低速时钟信号，常用于RTC和独立看门狗（IWDG）。
   - LSI的优点是成本低，电路设计简单，但频率精度和稳定性通常不如LSE。

STM32的时钟系统还包括时钟树（Clock Tree），它负责将上述时钟源分配到微控制器的各个模块。时钟树通常包括以下几个部分：

- **系统时钟（SYSCLK）**：微控制器的主时钟，可以由HSE、HSI或PLL（锁相环）产生。
- **AHB总线时钟（HCLK）**：用于微控制器的高速总线（AHB），通常是SYSCLK的分频。
- **APB1总线时钟（PCLK1）**：用于微控制器的低速外设总线（APB1），通常是HCLK的分频。
- **APB2总线时钟（PCLK2）**：用于微控制器的高速外设总线（APB2），通常是HCLK的分频。

通过配置时钟树，可以灵活地为微控制器的各个模块分配不同的时钟频率，以满足不同应用的需求。


## 配置系统时钟，总线时钟

### HSE

```c
  RCC_CR  |= RCC_CR_HSEON;
	while(!(RCC_CR & RCC_CR_HSERDY ));
	RCC_CFGR |= RCC_CFGR_SW_HSE;
	while ((RCC_CFGR & RCC_CFGR_SWS) != RCC_CFGR_SWS_HSE);
```

### HSI

```c
RCC_CR  |= RCC_CR_HSION;
while(!(RCC_CR & RCC_CR_HSIRDY ));
RCC_CFGR |= RCC_CFGR_SW_HSI;
while ((RCC_CFGR & RCC_CFGR_SWS) != RCC_CFGR_SWS_HSI);
```

### 主PLL

```c
  RCC_CR  |= RCC_CR_HSEON;
	while((RCC_CR & RCC_CR_HSERDY )==0); 
	
	
	//使能电源接口时钟
  //RCC_APB1ENR |= RCC_APB1ENR_PWREN;


 // PWR_CR |= PWR_CR_VOS;

	
  // 配置AHB分频器
  RCC_CFGR |= AHB_PRESCALER ;

  // 配置APB1分频器
  RCC_CFGR |= APB1_PRESCALER ;

  // 配置APB2分频器
  RCC_CFGR |= APB2_PRESCALER ;
	
 	RCC_PLLCFGR |=PLL_M_HSE ;
		RCC_PLLCFGR |=PLL_N ;
		RCC_PLLCFGR |=PLL_P ;
		RCC_PLLCFGR |=PLL_Q ;	
		RCC_PLLCFGR |=RCC_PLLCFGR_PLLSRC;		
 // RCC_PLLCFGR = (PLL_M_HSE << 0) | (PLL_N << 6) | (PLL_P << 16) | (PLL_Q << 24) | (RCC_PLLCFGR_PLLSRC);
 
 
  RCC_CR |=RCC_CR_PLLON ;
  while((RCC_CR & RCC_CR_PLLRDY ) == 0)	;
	
	/*为什么一定要加上这一行!!!!!!!!!!!!!!!!!!!!*/
	//Flash预取、指令缓存、数据缓存和等待状态
	FLASH_ACR = FLASH_ACR_PRFTEN | FLASH_ACR_ICEN |FLASH_ACR_DCEN |FLASH_ACR_LATENCY_5WS;

  RCC_CFGR |=RCC_CFGR_SW_PLL;
	while ((RCC_CFGR & RCC_CFGR_SWS) != RCC_CFGR_SWS_PLL);

```

**!!!**

```c
FLASH_ACR = FLASH_ACR_PRFTEN | FLASH_ACR_ICEN |FLASH_ACR_DCEN |FLASH_ACR_LATENCY_5WS;
```

1. 系统时钟频率与Flash访问速度的匹配
在高系统时钟频率下，CPU的执行速度会显著提高，但Flash的访问速度相对较慢。为了确保CPU能够高效地访问Flash，需要进行以下优化：

预取缓冲区（Prefetch Buffer）：启用预取缓冲区可以提高Flash的读取速度。预取缓冲区在读取Flash数据时提前预取数据，减少等待时间，从而提高系统性能。

指令缓存（Instruction Cache）：启用指令缓存可以加速指令的读取和执行。指令缓存将频繁执行的指令存储在高速缓存中，减少从Flash读取指令的次数，提高CPU的执行效率。

数据缓存（Data Cache）：启用数据缓存可以加速数据的读取和写入。数据缓存将频繁访问的数据存储在高速缓存中，减少从Flash读取数据的次数，提高数据访问速度。

等待状态（Latency）：设置Flash访问的等待状态。在高系统时钟频率下，Flash访问需要更多的等待时间，以确保数据可靠读取。FLASH_ACR_LATENCY_5WS 表示设置5个等待状态，以适应更高的系统时钟频率。

2. 实验结果分析
没有优化Flash访问性能：在没有加上 FLASH_ACR = FLASH_ACR_PRFTEN | FLASH_ACR_ICEN | FLASH_ACR_DCEN | FLASH_ACR_LATENCY_5WS; 这一句代码的情况下，PLL配置可能不成功，LED没有闪烁。这表明在高系统时钟频率下，Flash访问速度跟不上CPU的执行速度，导致系统不稳定或无法正常工作。

优化Flash访问性能：在加上这一句代码后，LED成功闪烁。这表明通过优化Flash访问性能，系统在高时钟频率下能够稳定运行，CPU能够高效地访问Flash，从而实现预期的功能。

**解释**

1. FLASH_ACR_PRFTEN
预取缓冲区使能（Prefetch Buffer Enable）：启用Flash预取缓冲区，可以提高Flash的读取速度。预取缓冲区在读取Flash数据时提前预取数据，减少等待时间，从而提高系统性能。

2. FLASH_ACR_ICEN
指令缓存使能（Instruction Cache Enable）：启用指令缓存，可以加速指令的读取和执行。指令缓存将频繁执行的指令存储在高速缓存中，减少从Flash读取指令的次数，提高CPU的执行效率。

3. FLASH_ACR_DCEN
数据缓存使能（Data Cache Enable）：启用数据缓存，可以加速数据的读取和写入。数据缓存将频繁访问的数据存储在高速缓存中，减少从Flash读取数据的次数，提高数据访问速度。

4. FLASH_ACR_LATENCY_5WS
等待状态（Latency）：设置Flash访问的等待状态。在高CPU时钟频率下，Flash访问需要更多的等待时间，以确保数据可靠读取。FLASH_ACR_LATENCY_5WS 表示设置5个等待状态，以适应更高的CPU时钟频率。

通俗解释
当CPU的时钟频率提高时，CPU的执行速度也会加快，但Flash的访问速度相对较慢。为了确保CPU能够高效地访问Flash，需要进行以下优化：

减少等待时间：通过启用预取缓冲区和设置适当的等待状态，减少CPU在访问Flash时的等待时间，提高系统性能。

加速指令和数据访问：通过启用指令缓存和数据缓存，减少从Flash读取指令和数据的次数，提高CPU的执行效率和数据访问速度。

通过这些优化措施，可以确保在高CPU时钟频率下，Flash的读取速度能够跟上CPU的访问速度，从而提高系统的整体性能和稳定性。

