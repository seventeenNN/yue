# GPIO

## 什么是GPIO

GPIO 是通用输入输出（General Purpose Input/Output）的缩写。它是一种在微控制器或微处理器上常见的硬件接口，允许用户通过编程来控制和读取数字信号。

GPIO引脚可以配置为多种模式，以适应不同的应用需求。

**输入模式（Input Mode）：**

```
    浮空输入（Floating Input）：GPIO 引脚对外部电路呈现高阻抗状态，用于读取外部设备的状态。

    上拉（Pull-Up）：通过内部上拉电阻将 GPIO 引脚拉高到高电平，适用于按钮等设备。

    下拉（Pull-Down）：通过内部下拉电阻将 GPIO 引脚拉低到低电平，适用于按钮等设备。
```

上/下拉电阻:控制引脚默认状态的电压

浮空状态:无信号输入时,该端口的电平是不确定的

**输出模式（Output Mode）：**

```
    推挽输出（Push-Pull）：GPIO 引脚可以输出高电平或低电平，提供较强的驱动能力。

    开漏输出（Open-Drain）：GPIO 引脚只能输出低电平或高阻态，需要外部上拉电阻输出高电平。

```


**模拟模式（Analog Mode）：**

```
在模拟模式下，GPIO 引脚被配置为直接接收或输出模拟信号。这意味着引脚不会进行数字信号的转换或处理，而是直接用于模拟电压信号的采样或输出。

相关的数字功能（如数字输入、输出或中断）被禁用。

模拟输入：
ADC（模拟到数字转换器）：当 GPIO 引脚配置为模拟模式时，它可以作为 ADC 的输入通道，用于读取外部模拟信号并将其转换为数字值。例如，读取传感器输出的模拟电压信号。

模拟输出：
DAC（数字到模拟转换器）：当 GPIO 引脚配置为模拟模式时，它可以作为 DAC 的输出通道，用于输出模拟信号。例如，生成一个控制电压信号以驱动外部设备。

```

**复用功能（Alternate Function）：**

```
复用功能是一种允许单个引脚或信号线在不同操作模式或功能之间切换的技术。在微控制器和数字电路中，复用功能使得一个引脚可以支持多种不同的功能，而不需要增加额外的硬件引脚。

GPIO 引脚的复用：

在微控制器中，GPIO 引脚可以配置为不同的功能模式，如数字输入、数字输出、模拟输入、外设接口等。例如，PA9 可能被配置为 UART1 的 TX 引脚，也可以配置为其他外设功能。

```



### 推挽和开漏

```

P                       Q                          输出

打开                  关闭                          高电平

                                                                  }  推挽
关闭                  打开                          低电平

                                                                 }开漏
关闭                  关闭                        浮空/高组态

```


#### 开漏的作用

（*开漏一般会外部配置一个上拉电阻*）

**多设备共享总线：**

开漏输出允许多个设备共享同一总线，因为每个设备的输出引脚在逻辑高电平时都处于高阻态。通过外部上拉电阻，总线可以在没有设备驱动时保持高电平状态。

例如，I2C 总线就是使用开漏输出配置，允许多个设备共享同一总线进行通信。

**电平转换：**

开漏输出可以用于实现不同电平标准之间的转换。通过选择合适的外部上拉电阻和电源电压，可以将开漏输出引脚的电平转换为所需的电平标准。

例如，将 3.3V 的开漏输出通过外部上拉电阻连接到 5V 电源，可以实现 3.3V 到 5V 的电平转换。

避免短路：

在某些情况下，如果两个设备的输出引脚同时为高电平，可能会导致短路。使用开漏输出可以避免这种情况，因为输出引脚在逻辑高电平时都处于高阻态。

简化电路设计：

开漏输出可以简化电路设计，特别是在需要多个设备共享总线或进行电平转换的场合。通过使用外部上拉电阻，可以灵活地配置输出引脚的电平。

提高抗干扰能力：

开漏输出在逻辑高电平时处于高阻态，可以减少对总线的干扰，提高系统的抗干扰能力。



### GPIO 端口输出速度寄存器 (GPIOx_OSPEEDR)

*这个寄存器的配置会影响GPIO引脚**切换电平**的速度*

在讨论GPIO引脚时，**输出频率**和**切换速率**是相关但不同的概念。

1. **输出频率 (Output Frequency)**
输出频率通常是指GPIO引脚在单位时间内（通常是一秒）进行电平切换的次数，换句话说，是引脚输出信号的振荡频率。例如，如果一个引脚每秒钟从低电平切换到高电平，再从高电平切换回低电平1000次，那么这个引脚的输出频率就是1 kHz。

**举个例子**：
- 如果你通过代码让一个GPIO引脚每秒钟切换电平100次，那么这个引脚的输出频率就是100 Hz。

2. **切换速率 (Switching Speed)**
切换速率指的是引脚电平从低到高（或从高到低）转换的快慢。这与电信号的上升时间（从低到高的过渡时间）和下降时间（从高到低的过渡时间）有关。切换速率由`GPIOx_OSPEEDR`寄存器配置的速度等级决定。

- **低速**：信号的上升时间和下降时间较长，切换比较慢。
- **高速**：信号的上升时间和下降时间较短，切换比较快。

**举个例子**：
- 假设一个引脚配置为低速模式，信号从低电平切换到高电平需要100纳秒；而配置为高速模式时，这个时间可能只有10纳秒。

### 3. **两者的关系**
- **输出频率**是指引脚电平在一段时间内重复切换的次数。它描述的是信号的频繁性。
- **切换速率**描述的是每次电平切换过程的快慢。它影响信号边沿的陡峭程度，但不决定信号切换的频率。

**关键区别**：
- 输出频率是指多长时间进行一次完整的电平切换（从低到高再回到低，或从高到低再回到高）。
- 切换速率是指每次切换从一个电平过渡到另一个电平的速度。

**4. 实际应用中的考虑**
- **输出频率**：对于频率较高的信号输出，系统时钟、定时器配置等是关键因素，决定了*信号切换的快慢*。
- **切换速率**：切换速率*影响信号质量*，尤其在高速通信中，切换速率直接影响信号的上升和下降时间。如果切换速率太慢，会导致信号不够陡峭，从而影响高频信号的完整性。



**输出频率**与系统时钟有关。输出频率描述的是GPIO引脚在一秒内切换电平的次数，这通常由系统时钟或外设时钟来控制和调节。

 1. **软件控制下的输出频率**

当你使用软件循环或延迟来控制GPIO引脚的切换时，输出频率直接受到系统时钟的影响。

例如，在主循环中使用简单的延时函数来切换GPIO引脚状态：

```c
while (1) {
    GPIOA->ODR ^= (1 << 0);  // 切换PA0状态
    delay(1000);             // 延时
}
```

在这种情况下，`delay`函数的执行时间取决于系统时钟的频率。如果系统时钟更高，`delay`函数执行得更快，导致GPIO切换得更频繁，从而输出频率更高。

 2. **外设控制下的输出频率**
    
如果你使用外设来控制GPIO引脚的切换，如使用定时器生成PWM信号、串行通信外设输出时钟信号等，输出频率通常由这些外设的时钟源决定。

- **定时器控制的频率**：定时器的时钟源通常来自系统时钟，通过预分频器设置可以生成所需的频率。例如，如果你配置一个定时器来生成1 kHz的PWM信号，这个频率是基于定时器时钟的分频比计算出来的。定时器的时钟源是系统时钟或其倍频/分频后的结果。

  假设系统时钟为72 MHz，你想要生成1 kHz的信号。你可以配置定时器的预分频器和自动重装值：

  ```c
  TIMx->PSC = 7199;  // 预分频器
  TIMx->ARR = 999;   // 自动重装值
  ```

  这样，定时器的更新频率（也就是GPIO引脚的切换频率）将是1 kHz。

- **通信外设的频率**：如SPI、UART等外设，其输出时钟频率也由系统时钟或外设时钟控制。这些时钟信号通常由系统时钟分频或倍频后产生。

3. **总结关联**
- **软件控制**：系统时钟直接影响输出频率，因为代码的执行速度依赖于系统时钟。
- **外设控制**：外设（如定时器、通信接口）的时钟源通常是系统时钟的一部分，系统时钟的频率会通过分频器或倍频器调节，最终决定外设控制的GPIO输出频率。



### 直接在GPIO_ODR中改变值的大小和通过GPIO_BSRR改变有什么区别

**GPIO_ODR（GPIO Output Data Register）：**

功能：GPIO_ODR 寄存器用于直接读取或写入 GPIO 引脚的输出状态。写入 GPIO_ODR 寄存器的值会直接影响到所有 GPIO 引脚的输出状态。

使用方式：通过写入 GPIO_ODR 寄存器，可以同时设置或清除多个 GPIO 引脚的状态。例如，写入 0x00FF 会将 GPIO 引脚的低 8 位设置为高电平，高 8 位设置为低电平。

**原子性：GPIO_ODR 寄存器的写入操作不是原子性的，可能会在写入过程中产生中间状态，导致短暂的输出不稳定。**

```c
GPIOA->ODR |= (1 << 0);
/*
它实际上包含两个步骤：
1.读取 GPIOA->ODR 的当前值。
2.将读取的值与 (1 << 0) 进行按位或运算，然后将结果写回 GPIOA->ODR。
*/
```

虽然这两个步骤在大多数情况下是连续执行的，但在多任务或中断环境中，这个操作可能不是原子操作。如果在这个操作过程中发生了中断或其他任务切换，可能会导致中间状态的出现，从而影响操作的完整性。

**GPIO_BSRR（GPIO Bit Set/Reset Register）：**

功能：GPIO_BSRR 寄存器用于单独设置或清除 GPIO 引脚的状态。它分为两个部分：高 16 位用于清除（复位）引脚，低 16 位用于设置（置位）引脚。

使用方式：通过写入 GPIO_BSRR 寄存器，可以单独设置或清除每个 GPIO 引脚的状态。例如，写入 0x0001 会将 GPIO 引脚 0 设置为高电平，写入 0x00020000 会将 GPIO 引脚 1 清除为低电平。

原子性：GPIO_BSRR 寄存器的写入操作是**原子性**的，可以确保在设置或清除引脚状态时不会产生中间状态，从而避免输出不稳定。

当你使用GPIO_BSRR寄存器同时改变**多个**引脚的值时，**这整个操作是原子性的。所有位的改变会在硬件上同步完成**


### GPIO 端口配置锁定寄存器 (GPIOx_LCKR)

只允许使用字访问

WR LCKR[16] = ‘1’ + LCKR[15:0]
WR LCKR[16] = ‘0’ + LCKR[15:0]
WR LCKR[16] = ‘1’ + LCKR[15:0]
RD LCKR
RD LCKR[16] = ‘1’（此读操作为可选操作，但它可确认锁定已激活）

**如果不进行这三步写操作，锁定机制将不会被激活，GPIO寄存器仍然可以被修改。这意味着，如果你只进行了一次或两次写操作，GPIO配置是不会被锁定的。**

（貌似是就必须这么做）

```c

    uint16_t lck_value = (1 << 0);  // 设置要锁定的 GPIO 引脚位
    GPIOA->LCKR = (1 << 16) | lck_value;  // 设置 LCKK[16] 和 LCKR[15:0]
    GPIOA->LCKR = (0 << 16) | lck_value;  // 清除 LCKK[16]，保持 LCKR[15:0]
    GPIOA->LCKR = (1 << 16) | lck_value;  // 再次设置 LCKK[16]，保持 LCKR[15:0]
    uint32_t lckr_value = GPIOA->LCKR;   // 读取 LCKR 寄存器的值
    if (lckr_value & (1 << 16)) {
        // 确认锁定已激活
    }

```

# DMA

## 简介

**DMA（Direct Memory Access，直接存储器访问）** 是一种计算机系统中的硬件功能，它允许外部设备直接访问系统内存而不经过中央处理器（CPU）的干预。

### DMA的主要特点和优点：

1. **减少CPU负载**：
   - DMA可以在外设和内存之间直接传输数据，而不需要CPU参与。这使得CPU可以腾出时间来处理其他任务，从而提高系统效率。

2. **高速数据传输**：
   - 由于DMA不需要CPU处理每一个字节的数据传输，它可以比通过CPU处理的传统方式更快地进行大批量数据传输。

3. **多种传输模式**：
   - **单次传输模式**：每传输一个数据，DMA控制器请求一次总线使用权。这种模式下，CPU和DMA控制器轮流使用总线。
   - **突发传输模式**：DMA控制器在获得总线控制权后，持续传输多个数据，直到完成任务或其他设备请求总线使用权。
   - **循环传输模式**：DMA传输完成后，可以自动重新开始传输（常用于音频数据处理）。

### DMA的工作流程：

1. **配置DMA控制器**：CPU首先配置DMA控制器，包括源地址、目标地址、数据传输大小等参数。

2. **启动传输**：CPU启动DMA传输。

3. **数据传输**：DMA控制器接管总线控制权，直接在外设和内存之间进行数据传输，而不需要CPU参与。

4. **传输完成**：当数据传输完成时，DMA控制器可以产生一个中断通知CPU，表明传输已经完成。

### DMA的应用：

DMA广泛应用于需要高效数据传输的场景，如：
- **音频和视频数据处理**：例如音频播放，视频捕获等。
- **数据采集**：如ADC（模数转换器）采集数据后，直接通过DMA传输到内存。
- **存储设备**：如硬盘、SD卡等的数据读写操作。

### DMA请求映射

发出请求的都是外设

**内存和存储器无法发出DMA请求：**

数据源和目标：内存（如SRAM、FLASH）本身只是数据的存储介质，它们*不会主动进行数据处理操作*。因此，它们没有发出DMA请求的能力。内存更多的是作为DMA操作的源（读取数据）或目标（写入数据）。

外设的主动性：外设通常具有主动进行数据处理的需求，例如，定时器可以定期发出DMA请求来更新其配置，而内存只是被动地保存数据，不具备发出请求的功能。

*若是M->M，直接使能流*

### 源地址和目标地址

DMA 控制器提供两个 AHB 主端口：AHB 存储器端口（用于连接存储器）和 AHB 外设端口 （用于连接外设）。但是，要执行存储器到存储器的传输，AHB 外设端口必须也能访问存储器。

```
DMA_SxCR 寄存器 的位
 DIR[1:0]        方向                源地址                     目标地址
00           外设到存储器           DMA_SxPAR                   DMA_SxM0AR
01           存储器到外设           DMA_SxM0AR                  DMA_SxPAR
10           存储器到存储器         DMA_SxPAR                   DMA_SxM0AR
11                保留                 -                            -
```


### 模式

#### 直接模式&FIFO模式

在STM32微控制器的DMA控制器中，**直接模式**（Direct Mode）和**FIFO模式**（FIFO Mode）是两种不同的工作模式，主要涉及到数据传输过程中如何处理数据缓冲和传输效率。以下是这两种模式的详细解释：

 **1. 直接模式（Direct Mode）**：

该模式仅限以下方式的传输：

● 源和目标传输宽度相等，并均由 DMA_SxCR 中的 PSIZE[1:0] 位定义（MSIZE[1:0] 位的 状态是“无关”）

● 不可能进行突发传输（DMA_SxCR 中的 PBURST[1:0] 和 MBURST[1:0] 位的状态是“无 关”）

当实现存储器到存储器传输时不得使用直接模式。


- **工作方式**：
  - 在直接模式下，DMA控制器不使用任何内部缓冲（如FIFO）。数据从源地址（外设或内存）直接传输到目标地址（外设或内存）。

  - 这种模式下，每次DMA传输会立即读取或写入数据，而不会进行数据的批量传输。

- **优点**：
  - **低延迟**：由于数据直接传输，直接模式通常具有更低的传输延迟，适合对实时性要求较高的应用。
  - **简单**：直接模式相对简单，配置较少，适用于对数据传输没有特殊需求的应用。

- **缺点**：
  - **效率较低**：因为每次传输只涉及一个数据单位（如一个字节或半字），所以效率较低，特别是在处理大批量数据时，无法充分利用总线带宽。
  - **数据不对齐问题**：如果源和目标地址不对齐，直接模式可能导致传输效率降低，甚至引发错误。

- **应用场景**：
  - 实时数据处理，如在ADC转换完成后立即将数据传输到内存中，或UART接收数据后立即存储。
  - 传输数据量较小或对延迟敏感的场景。

 **2. FIFO模式（FIFO Mode）**：

- **工作方式**：
  - 在FIFO模式下，DMA控制器使用内部的FIFO（First-In, First-Out）缓冲区来暂存数据。数据首先被写入FIFO，然后再从FIFO***批量***传输到目标地址。
  - FIFO的大小通常是4字（word），即16字节，可以通过DMA配置寄存器进行管理。

- **优点**：
  - **高效批量传输**：FIFO模式允许批量传输多个数据单位，从而提高了总线带宽的利用率，适合大数据量的传输。
  - **数据对齐优化**：FIFO模式可以处理未对齐的数据传输，并将数据对齐到总线宽度上，从而提高传输效率。
  - **突发传输支持**：支持突发模式，可以在一个传输周期内传输多个数据单位，进一步提高效率。

- **缺点**：
  - **增加延迟**：由于数据需要先写入FIFO再传输到目标地址，可能会增加传输的整体延迟，不适合需要极低延迟的应用。
  - **配置复杂**：需要设置FIFO阈值、突发大小等参数，配置相对复杂。

- **应用场景**：
  - 大数据量传输，如图像数据的处理，音频数据的连续传输。
  - 需要优化总线使用效率的场景，如高速外设与内存之间的大批量数据交换。

 **总结**：

- **直接模式**：数据直接传输，低延迟，但效率较低，适合小数据量或实时性高的场景。
- **FIFO模式**：利用内部缓冲区进行批量传输，效率高，但延迟稍高，适合大数据量传输和需要优化总线带宽利用率的场景。


#### 突发模式&单次模式

在STM32的DMA控制器中，**突发模式**（Burst Mode）和**单次模式**（Single Mode）是两种数据传输模式，主要区别在于数据传输的方式和效率。以下是这两种模式的详细解释：

 **1. 单次模式（Single Mode）**：

- **工作方式**：
  - 在单次模式下，DMA每次传输一个数据单位（如字节、半字、字），这意味着每个DMA请求对应一次数据传输操作。
  - 传输完成后，DMA控制器会根据配置递增或保持源地址和目标地址，然后等待下一个DMA请求。

- **优点**：
  - **低延迟**：每次DMA请求立即响应并传输一个数据单位，因此具有较低的延迟，适合对实时性要求较高的场合。
  - **简单易用**：配置简单，适用于不需要批量传输的应用场景。

- **缺点**：
  - **效率较低**：由于每次只能传输一个数据单位，总线利用率较低，特别是在处理大数据量时效率不高。
  - **总线占用频繁**：因为每次传输都占用一次总线资源，导致总线频繁切换，可能影响系统整体性能。

- **应用场景**：
  - 实时性要求高的应用，如ADC数据采集后立即存储到内存，或UART接收数据时逐字节存储。
  - 小数据量传输，或不需要优化总线使用的场景。

 **2. 突发模式（Burst Mode）**：

- **工作方式**：
  - 在突发模式下，DMA一次性传输多个数据单位（如4个、8个或16个字节），这些数据单位在一个DMA请求周期内批量传输。
  - 突发传输可以有效利用总线带宽，并减少总线切换的开销。

- **优点**：
  - **高效率**：由于在一个总线周期内传输多个数据单位，突发模式提高了总线带宽利用率，适合大数据量的传输。
  - **减少总线争用**：突发模式通过批量传输减少了总线切换的频率，有助于降低系统中的总线争用，提升整体性能。
  - **结合FIFO**：通常与DMA的FIFO模式结合使用，进一步优化传输效率和数据对齐。

- **缺点**：
  - **稍高延迟**：由于数据需要等待到一定数量后才进行批量传输，因此可能导致稍高的延迟，不适合要求极低延迟的应用。
  - **配置复杂**：需要配置突发传输的大小和相关参数，配置相对复杂。

- **应用场景**：
  - 大数据量的传输，如音频、视频数据的流式传输，或者图像数据的处理。
  - 需要高效利用总线资源，减少系统中总线争用的场合。

 **总结**：

- **单次模式**：每次传输一个数据单位，延迟低，适合小数据量或实时性要求高的场景，但效率较低。
- **突发模式**：每次传输多个数据单位，提高了传输效率和总线利用率，适合大数据量的传输，但延迟稍高，适合对效率要求较高的场景。


#### 循环模式

它允许DMA控制器在达到指定的传输次数或数据量后自动重置传输参数，从而实现连续的数据传输。

循环模式一次传完后，重置的内容通常包括以下几个方面：

1. 传输计数器（NDT）：

传输计数器（Number of Data Items to Transfer，NDT）用于记录剩余的传输数据项数目。在循环模式下，当NDT计数器达到0时，DMA控制器会自动将其重置为初始值，以便继续下一次传输。

2. 源地址和目的地址：

在循环模式下，源地址和目的地址通常不会重置为初始值。相反，它们会继续从上次传输结束的位置开始下一次传输。这样可以实现连续的数据流，而不会每次都从头开始。

3. DMA控制器状态：

DMA控制器的状态寄存器可能会重置，以便清除之前的传输状态，准备下一次传输。例如，清除传输完成标志或错误标志。

4. FIFO状态：

如果DMA控制器包含FIFO（First In, First Out）缓冲区，FIFO的状态可能会重置，以便清除之前的数据，准备接收新的数据。



#### 双缓冲模式

DMA 的双缓冲模式（Double Buffering Mode）是一种增强的 DMA 传输模式，用于提高数据传输效率和实时性。这种模式特别适合于需要连续数据流的应用，如音频处理、视频流和高速数据采集等。

**双缓冲模式的特点**

1. 两个缓冲区：

双缓冲模式利用两个缓冲区交替进行数据传输。DMA 在一个缓冲区进行数据传输的同时，另一个缓冲区可以被处理或填充新的数据。

2. 减少停顿：

通过交替使用两个缓冲区，双缓冲模式能够减少数据传输中的停顿或延迟，提高系统的整体数据处理效率。

3. 提高实时性：

在数据传输完成后，DMA 可以自动切换到另一个缓冲区，从而确保数据处理的连续性和实时性。



#### DMA 数据流 x 数据项数寄存器 (DMA_SxNDTR)

1. 如何确定该寄存器的值：

数据项（Data Item）：

一个数据项的大小取决于DMA的传输大小配置（即PSIZE和MSIZE寄存器），这可以是字节（8位）、半字（16位）或字（32位）。

例如，如果PSIZE和MSIZE都配置为半字（16位），那么一个数据项就是16位。如果配置为字节（8位），那么一个数据项就是8位。
NDT的值：

NDT[15:0]的值表示你希望DMA传输的数据项总数，范围可以是0到65535个数据项。

这个值表示的是数据项的数量，而不是总的数据大小（以字节为单位）。例如，如果NDT设置为100，PSIZE和MSIZE配置为16位（半字），那么DMA将传输100个16位的数据项。

如果你是以半字（half-word）传输，并且要传输100个字，那么你需要将NDT寄存器配置为200。

2. 传入未知数据量的数据

**循环模式（Circular Mode）：**

描述：当数据量未知时，你可以启用DMA的循环模式。在循环模式下，DMA在达到NDT指定的数据项数目后不会停止传输，而是会自动回到起始位置继续传输。这种模式下，DMA不断循环处理数据，直到手动停止或达到其他终止条件。

优点：适用于连续数据流的场景，如UART接收数据、ADC采样等。

实现方法：在DMA的配置中启用循环模式，并设置一个合理的NDT值来确定每次循环的数据量。

**使用外部信号或中断：**

描述：当无法确定数据量时，你可以结合DMA传输和外部信号（如数据完成信号）或使用中断来动态终止DMA传输。比如，配置一个外设产生中断，在中断处理程序中停止DMA或调整DMA的配置。

优点：可以灵活处理非固定数据量传输，适用于有明确结束标志的数据传输场景。

实现方法：配置外设产生传输完成中断，在中断处理程序中根据实际传输情况停止DMA。

**双缓冲模式（Double Buffer Mode）：**

描述：双缓冲模式允许你在DMA传输过程中切换源或目标缓冲区，这样可以在处理未知数据量时动态切换缓冲区，以继续传输或准备停止传输。

优点：适合需要高效连续处理大数据量的场景，比如音频处理或图像数据处理。

实现方法：配置DMA为双缓冲模式，使用两个缓冲区轮流进行数据传输，在数据传输完成或接近完成时动态决定是否继续或停止传输。

**动态调整NDT：**

描述：虽然DMA的NDT寄存器通常在传输开始前配置好，但你可以在传输过程中监控数据流量，动态调整NDT的值（在特定情况下，DMA允许你在传输过程中调整NDT值，具体情况取决于DMA通道是否支持这种操作）。

优点：允许在传输过程中动态控制数据项数目，灵活应对未知数据量。

实现方法：根据数据流的特性，动态调整NDT，或结合DMA传输中断或标志位，手动终止或重新配置DMA。

总结：

循环模式是处理未知数据量最简单且常见的方法，适用于数据流连续且无固定长度的场景。

外部信号或中断提供了对数据传输终止的精确控制，适合数据传输有明确结束标志的场景。

双缓冲模式适用于需要高效处理连续大数据量的应用场景。

动态调整NDT则适用于需要在传输过程中灵活处理数据量变化的情况。



#### PSIZE和MSIZE大小不同

在 **DMA（Direct Memory Access）** 传输中，`PSIZE` 和 `MSIZE` 分别代表 **外设数据宽度** 和 **存储器数据宽度**。它们的取值可以是 **8位**、**16位** 或 **32位**，并且它们不一定需要相同大小。

 如果 `PSIZE` 和 `MSIZE` 大小不一样，会发生以下情况：

 1. **数据对齐问题**
   - 当 `PSIZE` 和 `MSIZE` 设置不同时，DMA 控制器会自动进行数据对齐调整。例如，假设 `PSIZE` 设置为 16 位，而 `MSIZE` 设置为 32 位，DMA 会在传输时处理外设数据为 16 位，然后自动填充到 32 位的数据空间中。这会影响数据的排列和存储顺序，可能需要软件特别处理数据对齐问题。

 2. **效率影响**
   - **较大的数据传输单位效率更高**：例如，如果 `MSIZE` 设置为 32 位而 `PSIZE` 设置为 8 位，DMA 每次从外设接收 8 位数据，但写入存储器时每次要写 32 位，这意味着每次需要填充四个 8 位数据才完成一次存储器写入。这样会导致 DMA 控制器必须多次操作，效率相对较低。
   
   - **传输速率不同步**：如果 `PSIZE` 和 `MSIZE` 不同，传输过程中 DMA 控制器可能会在外设和存储器之间进行额外的缓冲操作，以确保数据不会丢失或错位。这种操作可能会导致传输速率降低。

 3. **数据截断或填充**
   - 如果 `PSIZE` 小于 `MSIZE`，例如 `PSIZE` 为 8 位，`MSIZE` 为 32 位，DMA 会自动在存储器中进行填充操作，以确保 32 位数据空间被填满。这种情况可能会产生多余的填充数据，需要软件对其进行处理。
   
   - 反之，如果 `PSIZE` 大于 `MSIZE`，例如 `PSIZE` 为 32 位，而 `MSIZE` 为 8 位，DMA 会截断 32 位的数据，只传输其中的 8 位。这种情况可能会导致数据丢失，尤其是在对数据完整性有较高要求的应用中。

典型应用场景
- **PSIZE ≠ MSIZE** 的情况在某些特殊应用中很常见，例如从 **外设寄存器** 读取较小的数据，然后将其存储到内存中较大的数据块中，或者反过来。  
  例如，在处理 **串行外设接口**（如 UART 或 SPI）时，外设数据通常较小（如 8 位或 16 位），但可能需要存储到内存中较大的数据单元（如 32 位）。

总结
- 如果 `PSIZE` 和 `MSIZE` 不相同，DMA 控制器会自动调整数据的存储和传输，以匹配两者的大小差异。这种调整可能会导致数据对齐问题、传输效率下降、数据填充或截断等情况。
- 因此，在设置 `PSIZE` 和 `MSIZE` 时，应根据具体的应用需求选择合适的配置，以避免不必要的数据处理问题。




